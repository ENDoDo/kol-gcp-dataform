-- =================================================================
-- race_uma_details.sqlx
-- 説明: race_umaテーブルとraceテーブルを結合し、馬毎のレース詳細情報を持つテーブルを作成する。
-- =================================================================

-- Dataform設定ブロック
config {
  type: "table",
  dependencies: [ "race", "race_uma" ],
  description: "馬毎のレース情報(race_uma)とレース自体の情報(race)を結合した詳細テーブル。",
  columns: {
    // ID / コード
    race_code_uma_kol: "KOL仕様馬毎レースID",
    race_code_uma_jvd: "JRA-VAN仕様馬毎レースID",
    race_code_kol: "KOL仕様レースID",
    race_code_jvd: "JRA-VAN仕様レースID",
    keibajo_code_jvd: "JRA-VAN仕様競馬場コード",
    keibajo_code_kol: "KOL仕様競馬場コード",
    hasso_date: "発走日時",
    kaiji: "開催回次",
    nichiji: "開催日次",
    race_bango: "レース番号 2桁",
    race_bango_num: "レース番号 整数型",
    waku_kubun: "枠番区分",
    wakuban: "枠番",
    umaban: "馬番 2桁",
    umaban_num: "馬番 整数型",
    umaban_even: "馬番が偶数",
    // 馬情報
    bamei: "馬名",
    seibetsu_code: "性別コード",
    seibetsu_code_label: "性別 牡/牝/せん",
    barei: "馬齢",
    barei_num: "馬齢 整数型",
    futan_juryo: "負担重量 単位:0.1kg",
    futan_juryo_float: "負担重量 小数点第一位まで",
    blinker_shiyo_kubun: "ブリンカー使用区分",
    blinker_shiyo_kubun_label: "ブリンカー使用 はい/いいえ",
    rating: "レイティング 3桁",
    rating_float: "レイティング 小数点第一位まで",
    // 馬主・血統
    banushimei: "馬主名",
    banushimei_ryakusho: "馬主名略称",
    ketto_toroku_bango_kol: "KOL仕様 血統登録番号(馬コード)",
    ketto1_f_hanshoku_toroku_bango: "血統情報 父 繁殖登録番号",
    ketto1_f_bamei: "血統情報 父 馬名",
    ketto2_m_hanshoku_toroku_bango: "血統情報 母 繁殖登録番号",
    ketto2_m_bamei: "血統情報 母 馬名",
    ketto5_mf_hanshoku_toroku_bango: "血統情報 母父 繁殖登録番号",
    ketto5_mf_bamei: "血統情報 母父 馬名",
    kyuyo_riyu: "休養理由",
    // 騎手
    kishumei: "騎手名",
    kishumei_ryakusho: "騎手名略称",
    kishu_code: "騎手コード",
    kishu_tozai_shozoku_code: "騎手東西所属区分",
    kishu_tozai_shozoku_code_label: "騎手東西所属 西/東/招待",
    kishu_minarai_code: "騎手見習コード",
    kishu_minarai_code_label: "騎手見習",
    kishu_norikawari_kubun: "騎手乗り替わり区分",
    kishu_norikawari_kubun_label: "騎手乗り替わり はい/いいえ",
    kishu_shozokubasho_code: "騎手所属場所コード",
    kishu_shozokubasho_code_label: "騎手所属場所",
    kishu_shozoku_chokyoshi_code: "騎手が所属する調教師コード",
    // 調教師
    chokyoshi_code: "調教師コード",
    chokyoshimei: "調教師名",
    chokyoshimei_ryakusho: "調教師名略称",
    chokyoshi_shozokubasho_code: "調教師所属場所コード",
    chokyoshi_shozokubasho_code_label: "調教師所属場所",
    chokyoshi_tracen_kubun: "調教師トレセン区分",
    chokyoshi_tracen_kubun_label: "調教師トレセン区分",
    // 調教 (den2/sei2由来)
    chokyo_flag: "調教フラグ",
    chokyo_flag_label: "調教フラグ はい/いいえ",
    chokyo_kijosha: "調教騎乗者",
    chokyo_kijosha_equal_kishumei_flag: "調教騎乗騎手がレースでも騎乗フラグ",
    chokyo_nengappi_date: "調教年月日",
    chokyo_basho: "調教場所",
    chokyo_course: "調教コース",
    chokyo_course_kubun: "調教コース区分",
    chokyo_basho_course_label: "調教場所とコースを結合したラベル",
    chokyo_babajotai: "調教馬場状態",
    chokyo_hanro_pool_kaisu_int: "坂路またはプール:chokyo_6f それ以外:null",
    chokyo_8f: "調教タイム 8F",
    chokyo_8f_float: "調教タイム 8F (小数点)",
    chokyo_7f: "調教タイム 7F",
    chokyo_7f_float: "調教タイム 7F (小数点)",
    chokyo_6f: "調教タイム 6F",
    chokyo_6f_float: "調教タイム 6F (小数点)",
    chokyo_5f: "調教タイム 5F",
    chokyo_5f_float: "調教タイム 5F (小数点)",
    chokyo_4f: "調教タイム 4F",
    chokyo_4f_float: "調教タイム 4F (小数点)",
    chokyo_3f: "調教タイム 3F",
    chokyo_3f_float: "調教タイム 3F (小数点)",
    chokyo_2f_float: "調教タイム 2F推定値 (小数点)",
    chokyo_1f: "調教タイム 1F",
    chokyo_1f_float: "調教タイム 1F (小数点)",
    chokyo_lap_8f: "追い切り 8Fラップタイム 8f-7f",
    chokyo_lap_7f: "追い切り 7Fラップタイム 7f-6f",
    chokyo_lap_6f: "追い切り 6Fラップタイム 6f-5f",
    chokyo_lap_5f: "追い切り 5Fラップタイム 5f-4f",
    chokyo_lap_4f: "追い切り 4Fラップタイム 4f-3f",
    chokyo_lap_3f: "追い切り 3Fラップタイム 3f-2f",
    chokyo_lap_2f: "追い切り 2Fラップタイム 2f-1f",
    chokyo_lap_group: "調教ラップグループ A1-B3",
    chokyo_ichidori: "調教位置取り",
    chokyo_ichidori_label: "調教位置取り(ラベル)",
    chokyo_ashiiro: "調教脚色",
    chokyo_ashiiro_label: "調教脚色(ラベル)",
    chokyo_yajirushi: "調教矢印",
    chokyo_yajirushi_label: "調教矢印(ラベル)",
    chokyo_reigai: "調教例外",
    chokyo_awase: "調教併せ",
    chokyo_awase_kubun: "調教併せ区分",
    chokyo_awase_flag: "調教併せフラグ",
    chokyo_awase_flag_label: "調教併せフラグ（ラベル）",
    chokyo_tanpyo: "ブックによる調教短評",
    chokyo_honsu_course: "調教本数 コース",
    chokyo_honsu_course_num: "調教本数 コース(整数)",
    chokyo_honsu_hanro: "調教本数 坂路",
    chokyo_honsu_hanro_num: "調教本数 坂路(整数)",
    chokyo_honsu_pool: "調教本数 プール",
    chokyo_honsu_pool_num: "調教本数 プール(整数)",
    // スピード指数・ローテーション
    speed_sisu_last_1: "スピード指数 1走前",
    speed_sisu_last_1_float: "スピード指数 1走前(小数点)",
    speed_sisu_last_2: "スピード指数 2走前",
    speed_sisu_last_2_float: "スピード指数 2走前(小数点)",
    speed_sisu_last_3: "スピード指数 3走前",
    speed_sisu_last_3_float: "スピード指数 3走前(小数点)",
    speed_sisu_last_4: "スピード指数 4走前",
    speed_sisu_last_4_float: "スピード指数 4走前(小数点)",
    speed_sisu_last_5: "スピード指数 5走前",
    speed_sisu_last_5_float: "スピード指数 5走前(小数点)",
    rotation1: "ローテーション1週前",
    rotation1_label: "ローテーション1週前(ラベル)",
    rotation2: "ローテーション2週前",
    rotation2_label: "ローテーション2週前(ラベル)",
    rotation3: "ローテーション3週前",
    rotation3_label: "ローテーション3週前(ラベル)",
    rotation4: "ローテーション4週前",
    rotation4_label: "ローテーション4週前(ラベル)",
    rotation5: "ローテーション5週前",
    rotation5_label: "ローテーション5週前(ラベル)",
    rotation6: "ローテーション6週前",
    rotation6_label: "ローテーション6週前(ラベル)",
    rotation7: "ローテーション7週前",
    rotation7_label: "ローテーション7週前(ラベル)",
    rotation8: "ローテーション8週前",
    rotation8_label: "ローテーション8週前(ラベル)",
    zensou_kankaku: "前走との間隔。rotatin1～8の確定着順をもとに判定 連闘/中1周/中2週/中3週/中4週/中5週/中6週/中7週",
    // 馬体重・前走比較
    bataiju: "馬体重(kg)",
    bataiju_kubun: "馬体重区分",
    bataiju_zensou: "前走 馬体重kg",
    bataiju_kubun_zensou: "前走 馬体重区分",
    kyori_kubun_zensou: "前走 距離区分",
    kyori_extension_flag: "距離延長フラグ",
    kyori_shortening_flag: "距離短縮フラグ",
    ensei_kansai_to_kantou_flag: "遠征 関西→関東",
    ensei_kantou_to_kansai_flag: "遠征 関東→関西",
    ensei_flag: "遠征フラグ",
    track_code1_label_dirtsiba_zensou: "前走 ダ/芝",
    siba_to_dirt_flag: "芝→ダ替わりフラグ",
    dirt_to_siba_flag: "ダ→芝替わりフラグ",
    // 成績 (sei2)
    record_shisu: "レコード指数",
    record_shisu_num: "レコード指数(整数)",
    zogen_sa: "増減差",
    zogen_sa_num: "増減差(整数)",
    tansho_ninkijun: "単勝人気順",
    tansho_ninkijun_num: "単勝人気順(整数)",
    tansho_odds: "単勝オッズ",
    tansho_odds_float: "単勝オッズ(小数点)",
    kakutei_chakujun: "確定着順",
    kakutei_chakujun_num: "確定着順(整数)",
    tansho_haraimodoshi: "単勝払戻",
    tansho_haraimodoshi_num: "単勝払戻(整数)",
    fukusho_haraimodoshi: "複勝払戻",
    fukusho_haraimodoshi_num: "複勝払戻(整数)",
    ijo_kubun_code1: "異常区分コード1",
    ijo_kubun_code1_label: "異常区分コード1(ラベル)",
    ijo_kubun_code2: "異常区分コード2",
    ijo_kubun_code2_label: "異常区分コード2(ラベル)",
    nyusen_juni: "入線順位",
    nyusen_juni_num: "入線順位(整数)",
    record_flag: "レコードフラグ",
    record_flag_label: "レコードフラグ(ラベル)",
    soha_time: "走破タイム",
    soha_time_float: "走破タイム(秒換算)",
    soha_time_label: "走破タイム(xx分xx.x秒)",
    chakusa_code1: "着差コード1",
    chakusa_code1_num: "着差コード1(整数)",
    chakusa_code2: "着差コード2",
    chakusa_code2_label: "着差コード2(ラベル)",
    chakusa_label: "着差(ラベル)",
    time_sa: "タイム差",
    time_sa_float: "タイム差(小数点)",
    zenhan_3f: "前半3F",
    zenhan_3f_float: "前半3F(小数点)",
    kohan_3f: "後半3F",
    kohan_3f_float: "後半3F(小数点)",
    corner1_juni: "1角順位",
    corner1_juni_label: "1角順位(ラベル)",
    corner2_juni: "2角順位",
    corner2_juni_label: "2角順位(ラベル)",
    corner3_juni: "3角順位",
    corner3_juni_label: "3角順位(ラベル)",
    corner4_juni: "4角順位",
    corner4_juni_label: "4角順位(ラベル)",
    corner4_ichidori: "4角位置取り",
    corner4_ichidori_label: "4角位置取り(ラベル)",
    // --- raceテーブル由来のカラム ---
    race_name: "レース名。オープン競走では競走名とグレード、それ以外では条件を組み合わせて生成",
    kyori_kubun: "短距離(～1399m)/マイル(1400m～1699m)/中距離(1700m～2099m)/長距離(2100m～)",
    keibajo_name: "札幌/函館/福島/新潟/東京/中山/中京/京都/阪神/小倉",
    chuo_chiho_kubun: "中央･地方･外国 区分",
    chuo_chiho_kubun_label: "chuo_chiho_kubunをもとに対応 中央/南関東/その他の公営/道営/外国",
    kyosomei_15moji: "競走名15文字",
    kyosomei_7moji: "競走名7文字",
    grade_code: "グレードコード",
    grade_code_label: "grade_codeをもとに対応 GⅠ/GⅡ/GⅢ/JGⅠ/JGⅡ/JGⅢ",
    jpn_flag: "Jpnフラグ",
    jpn_flag_label: "grade_codeの有無をもとに対応 国際格付けレース（G）/それ以外の重賞（Jpn）",
    bettei_barei_handicap_summary_code: "重量種別コード(別定馬齢ハンデ概要コード)",
    bettei_barei_handicap_summary_code_label: "bettei_barei_handicap_summary_codeをもとに対応 別定/馬齢/ハンデ/定量/規定(道営のみ)",
    bettei_barei_handicap_detail: "別定/馬齢/ハンデ/定量/規定（道営のみ）/牡 55 K/牝 53 K/牝2K減",
    kyoso_joken_age_limit: "競走種別コード2 条件年齢制限",
    kyoso_joken_age_limit_label: "kyoso_joken_age_limitをもとに対応 2歳/3歳/4歳/3,4,5歳/4,5,6歳/3歳以上/4歳以上/3,4歳/4,5歳",
    kyoso_joken_kubun: "競走条件コード1 競走条件区分",
    kyoso_joken_kubun_label: "kyoso_joken_kubunをもとに対応 新馬/未出走/未勝利/1勝クラス/2勝クラス/3勝クラス/オープン",
    heichi_shogai_kubun: "平地･障害 区分",
    heichi_shogai_kubun_label: "heichi_shogai_kubunをもとに対応 平地/障害",
    track_code1_dirtsiba: "トラックコード ダ･芝",
    track_code1_dirtsiba_label: "track_code1をもとに対応 ダ/芝",
    track_code2_LRS: "トラックコード 右･左",
    track_code2_LRS_label: "track_code2をもとに対応 右/左/直線",
    track_code3_inout: "トラックコード 内･外",
    track_code3_inout_label: "track_code3をもとに対応 内/外/外→内/タスキ/大障害/内２週/内→外",
    course_kubun: "コース区分",
    course_kubun_label: "course_kubunをもとに対応 A/B/C/D/A1/A2/E",
    kyori: "距離",
    toroku_tosu_num: "登録頭数 整数型",
    torikeshi_tosu_num: "取消頭数 整数型",
    tenko_code: "天候コード",
    tenko_code_label: "天候コードラベル (晴, 曇, 雨...)",
    babajotai_code: "馬場状態コード",
    babajotai_code_label: "馬場状態ラベル (良, 稍, 重, 不良)",
    pace_yosou: "ペース(予想)",
    pace_yosou_label: "ペース(予想) ラベル (H, M, S)",
    pace_kekka: "ペース(結果)",
    pace_kekka_label: "ペース(結果) ラベル (H, M, S)",
    race_tanpyo: "レース短評",
    juryo_handicap_flag: "重量種別が別定または馬齢の場合に「はい」",
    keibajo_komawari_curve4_flag: "競馬場が札幌/函館/福島/小倉かつ距離が1700m以上の場合に「はい」",
    keibajo_omawari_curve4_flag: "指定された競馬場、トラック、距離の組み合わせ条件を満たす場合に「はい」",
    keibajo_straight_short_flag: "指定された競馬場、トラックの組み合わせ条件を満たす場合に「はい」",
    keibajo_straight_long_flag: "東京芝、阪神芝外回り、新潟芝外回りの場合に「はい」",
    // --- タイムスタンプ ---
    created: "データ作成日時",
    modified: "データ更新日時"
  }
}

-- CTE: race_umaとraceテーブルを結合
-- メインクエリ: カラムを選択し、重複を除外
SELECT
  ru.*,
  r.* EXCEPT (
    -- race_umaと重複するカラムをraceテーブルから除外
    race_code_kol, race_code_jvd, hasso_date, kaiji, nichiji, race_bango, race_bango_num,
    keibajo_code_jvd, keibajo_code_kol, created, modified
  )
FROM
  ${ref("race_uma")} AS ru
  LEFT JOIN ${ref("race")} AS r
  ON ru.race_code_jvd = r.race_code_jvd
WHERE
  ru.kakutei_chakujun_num >= 1