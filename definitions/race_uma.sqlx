-- =================================================================
-- race_uma.sqlx
-- 説明: kol_den2, kol_sei1, kol_sei2, kol_ket, raceを結合し、出走馬に関する情報を整形するテーブル。
--       KOL仕様のコードをJRA-VAN仕様に変換し、各種ラベルやフラグ、計算済みのフィールドを付与する。
-- =================================================================

-- Dataform設定ブロック
config {
  type: "table",
  description: "KOLの出馬表(den2), 成績(sei1, sei2), 血統(ket), レース(race)データを結合し、出走馬に関する情報を整形したマスターテーブル。",
  columns: {
    race_code_uma_kol: "KOL仕様馬毎レースID",
    race_code_uma_jvd: "JRA-VAN仕様馬毎レースID",
    race_code_kol: "KOL仕様レースID",
    race_code_jvd: "JRA-VAN仕様レースID",
    keibajo_code_jvd: "JRA-VAN仕様競馬場コード",
    keibajo_code_kol: "KOL仕様競馬場コード",
    hasso_date: "発走日時",
    kaiji: "開催回次",
    nichiji: "開催日次",
    race_bango: "レース番号 2桁",
    race_bango_num: "レース番号 整数型",
    waku_kubun: "枠番区分",
    wakuban: "枠番",
    umaban: "馬番 2桁",
    umaban_num: "馬番 整数型",
    umaban_even: "馬番が偶数",
    bamei: "馬名",
    seibetsu_code: "性別コード",
    seibetsu_code_label: "性別 牡/牝/せん",
    barei: "馬齢",
    barei_num: "馬齢 整数型",
    futan_juryo: "負担重量 単位:0.1kg",
    futan_juryo_float: "負担重量 小数点第一位まで",
    blinker_shiyo_kubun: "ブリンカー使用区分",
    blinker_shiyo_kubun_label: "ブリンカー使用 はい/いいえ",
    rating: "レイティング 3桁",
    rating_float: "レイティング 小数点第一位まで",
    banushimei: "馬主名",
    banushimei_ryakusho: "馬主名略称",
    ketto_toroku_bango_kol: "KOL仕様 血統登録番号(馬コード)",
    ketto1_f_hanshoku_toroku_bango: "血統情報 父 繁殖登録番号",
    ketto1_f_bamei: "血統情報 父 馬名",
    ketto2_m_hanshoku_toroku_bango: "血統情報 母 繁殖登録番号",
    ketto2_m_bamei: "血統情報 母 馬名",
    ketto5_mf_hanshoku_toroku_bango: "血統情報 母父 繁殖登録番号",
    ketto5_mf_bamei: "血統情報 母父 馬名",
    kyuyo_riyu: "休養理由",
    kishumei: "騎手名",
    kishumei_ryakusho: "騎手名略称",
    kishu_code: "騎手コード",
    kishu_tozai_shozoku_code: "騎手東西所属区分",
    kishu_tozai_shozoku_code_label: "騎手東西所属 西/東/招待",
    kishu_minarai_code: "騎手見習コード",
    kishu_minarai_code_label: "騎手見習",
    kishu_norikawari_kubun: "騎手乗り替わり区分",
    kishu_norikawari_kubun_label: "騎手乗り替わり はい/いいえ",
    kishu_shozokubasho_code: "騎手所属場所コード",
    kishu_shozokubasho_code_label: "騎手所属場所",
    kishu_shozoku_chokyoshi_code: "騎手が所属する調教師コード",
    chokyoshi_code: "調教師コード",
    chokyoshimei: "調教師名",
    chokyoshimei_ryakusho: "調教師名略称",
    chokyoshi_shozokubasho_code: "調教師所属場所コード",
    chokyoshi_shozokubasho_code_label: "調教師所属場所",
    chokyoshi_tracen_kubun: "調教師トレセン区分",
    chokyoshi_tracen_kubun_label: "調教師トレセン区分",
    chokyo_flag: "調教フラグ",
    chokyo_flag_label: "調教フラグ はい/いいえ",
    chokyo_kijosha: "調教騎乗者",
    chokyo_date: "調教年月日",
    chokyo_basho: "調教場所",
    chokyo_course: "調教コース",
    chokyo_babajotai: "調教馬場状態",
    chokyo_1f: "調教タイム 1F",
    chokyo_3f: "調教タイム 3F",
    chokyo_4f: "調教タイム 4F",
    chokyo_5f: "調教タイム 5F",
    chokyo_6f: "調教タイム 6F",
    chokyo_7f: "調教タイム 7F",
    chokyo_8f: "調教タイム 8F",
    chokyo_ichidori: "調教位置取り",
    chokyo_ashiiro: "調教脚色",
    chokyo_yajirushi: "調教矢印",
    chokyo_yajirushi_label: "調教矢印(ラベル)",
    chokyo_reigai: "調教例外",
    chokyo_awase: "調教併せ",
    chokyo_awase_kubun: "調教併せ区分",
    chokyo_awase_flag: "調教併せフラグ",
    chokyo_awase_flag_label: "調教併せフラグ（ラベル）",
    chokyo_tanpyo: "ブックによる調教短評",
    chokyo_honsu_course: "調教本数 コース",
    chokyo_honsu_course_num: "調教本数 コース(整数)",
    chokyo_honsu_hanro: "調教本数 坂路",
    chokyo_honsu_hanro_num: "調教本数 坂路(整数)",
    chokyo_honsu_pool: "調教本数 プール",
    chokyo_honsu_pool_num: "調教本数 プール(整数)",
    speed_sisu_last_1: "スピード指数 1走前",
    speed_sisu_last_1_float: "スピード指数 1走前(小数点)",
    speed_sisu_last_2: "スピード指数 2走前",
    speed_sisu_last_2_float: "スピード指数 2走前(小数点)",
    speed_sisu_last_3: "スピード指数 3走前",
    speed_sisu_last_3_float: "スピード指数 3走前(小数点)",
    speed_sisu_last_4: "スピード指数 4走前",
    speed_sisu_last_4_float: "スピード指数 4走前(小数点)",
    speed_sisu_last_5: "スピード指数 5走前",
    speed_sisu_last_5_float: "スピード指数 5走前(小数点)",
    rotation1: "ローテーション1週前",
    rotation1_label: "ローテーション1週前(ラベル)",
    rotation2: "ローテーション2週前",
    rotation2_label: "ローテーション2週前(ラベル)",
    rotation3: "ローテーション3週前",
    rotation3_label: "ローテーション3週前(ラベル)",
    rotation4: "ローテーション4週前",
    rotation4_label: "ローテーション4週前(ラベル)",
    rotation5: "ローテーション5週前",
    rotation5_label: "ローテーション5週前(ラベル)",
    rotation6: "ローテーション6週前",
    rotation6_label: "ローテーション6週前(ラベル)",
    rotation7: "ローテーション7週前",
    rotation7_label: "ローテーション7週前(ラベル)",
    rotation8: "ローテーション8週前",
    rotation8_label: "ローテーション8週前(ラベル)",
    bataiju: "馬体重(kg)",
    bataiju_kubun: "馬体重区分",
    bataiju_zensou: "前走 馬体重kg",
    bataiju_kubun_zensou: "前走 馬体重区分",
    kyori_kubun_zensou: "前走 距離区分",
    kyori_extension_flag: "距離延長フラグ",
    kyori_shortening_flag: "距離短縮フラグ",
    ensei_kansai_to_kantou_flag: "遠征 関西→関東",
    ensei_kantou_to_kansai_flag: "遠征 関東→関西",
    ensei_flag: "遠征フラグ",
    track_code1_label_dirtsiba_zensou: "前走 ダ/芝",
    siba_to_dirt_flag: "芝→ダ替わりフラグ",
    dirt_to_siba_flag: "ダ→芝替わりフラグ",
    record_shisu: "レコード指数",
    record_shisu_num: "レコード指数(整数)",
    zogen_sa: "増減差",
    zogen_sa_num: "増減差(整数)",
    tansho_ninkijun: "単勝人気順",
    tansho_ninkijun_num: "単勝人気順(整数)",
    tansho_odds: "単勝オッズ",
    tansho_odds_float: "単勝オッズ(小数点)",
    kakutei_chakujun: "確定着順",
    kakutei_chakujun_num: "確定着順(整数)",
    tansho_haraimodoshi: "単勝払戻",
    fukusho_haraimodoshi: "複勝払戻",
    ijo_kubun_code1: "異常区分コード1",
    ijo_kubun_code1_label: "異常区分コード1(ラベル)",
    ijo_kubun_code2: "異常区分コード2",
    ijo_kubun_code2_label: "異常区分コード2(ラベル)",
    nyusen_juni: "入線順位",
    nyusen_juni_num: "入線順位(整数)",
    record_flag: "レコードフラグ",
    record_flag_label: "レコードフラグ(ラベル)",
    soha_time: "走破タイム",
    soha_time_float: "走破タイム(秒換算)",
    soha_time_label: "走破タイム(xx分xx.x秒)",
    chakusa_code1: "着差コード1",
    chakusa_code1_num: "着差コード1(整数)",
    chakusa_code2: "着差コード2",
    chakusa_code2_label: "着差コード2(ラベル)",
    chakusa_label: "着差(ラベル)",
    time_sa: "タイム差",
    time_sa_float: "タイム差(小数点)",
    zenhan_3f: "前半3F",
    zenhan_3f_float: "前半3F(小数点)",
    kohan_3f: "後半3F",
    kohan_3f_float: "後半3F(小数点)",
    corner1_juni: "1角順位",
    corner1_juni_label: "1角順位(ラベル)",
    corner2_juni: "2角順位",
    corner2_juni_label: "2角順位(ラベル)",
    corner3_juni: "3角順位",
    corner3_juni_label: "3角順位(ラベル)",
    corner4_juni: "4角順位",
    corner4_juni_label: "4角順位(ラベル)",
    corner4_ichidori: "4角位置取り",
    corner4_ichidori_label: "4角位置取り(ラベル)",
    created: "データ作成日時",
    modified: "データ更新日時"
  }
}

-- CTE Step1: 全てのソーステーブルを結合し、基本的な整形を行うベーステーブルを作成
WITH
  base_data AS (
    SELECT
      d2.race_code_uma_kol,
      SUBSTR(d2.race_code_uma_kol, 1, 16) AS race_code_kol,
      CASE d2.keibajo_code WHEN '08' THEN '01' WHEN '09' THEN '02' WHEN '06' THEN '03' WHEN '07' THEN '04' WHEN '04' THEN '05' WHEN '05' THEN '06' WHEN '02' THEN '07' WHEN '00' THEN '08' WHEN '01' THEN '09' WHEN '03' THEN '10' ELSE NULL END AS keibajo_code_jvd_from_kol,
      d2.kaisai_nengappi, d2.kaisai_kaiji, d2.kaisai_nichiji, d2.race_num, d2.umaban,
      d2.ketto_toroku_bango, -- d2.hasso_jikoku は存在しないため削除
      r.hasso_date, -- raceテーブルからhasso_dateを取得
      d2.wakuban, d2.bamei, d2.seibetsu_code, d2.barei, d2.futan_juryo, d2.blinker_shiyo_kubun, d2.rating, d2.banushimei, d2.banushimei_ryakusho,
      d2.kyuyo_riyu, d2.kishu_code, d2.kishumei, d2.kishumei_ryakusho, d2.kishu_tozai_shozoku_code, d2.kishu_minarai_code, d2.kishu_norikawari_kubun,
      d2.kishu_shozokubasho_code, d2.kishu_shozoku_chokyoshi_code, d2.chokyoshi_code, d2.chokyoshimei, d2.chokyoshimei_ryakusho,
      d2.chokyoshi_shozokubasho_code, d2.chokyoshi_tracen_kubun, d2.keibajo_code, d2.chokyo_ashiiro,
      d2.speed_shisu1, d2.speed_shisu2, d2.speed_shisu3, d2.speed_shisu4, d2.speed_shisu5,
      d2.rotation1, d2.rotation2, d2.rotation3, d2.rotation4, d2.rotation5, d2.rotation6, d2.rotation7, d2.rotation8,
      s2.record_shisu, s2.bataiju, s2.zogen_sa, s2.tansho_ninkijun, s2.tansho_odds, s2.kakutei_chakujun,
      s2.nyusen_juni, s2.ijo_kubun_code1, s2.ijo_kubun_code2, s2.record_flag, s2.soha_time,
      s2.time_sa, s2.zenhan_3f, s2.kohan_3f, s2.chakusa_code1, s2.chakusa_code2,
      s2.corner1_juni, s2.corner2_juni, s2.corner3_juni, s2.corner4_juni, s2.corner4_ichidori,
      s2.chokyo_flag, s2.chokyo_kijosha, s2.chokyo_nengappi, s2.chokyo_basho, s2.chokyo_course, s2.chokyo_babajotai,
      s2.chokyo_8f, s2.chokyo_7f, s2.chokyo_6f, s2.chokyo_5f, s2.chokyo_4f, s2.chokyo_3f, s2.chokyo_1f,
      s2.chokyo_ichidori, s2.chokyo_asiiro, s2.chokyo_yajirushi, s2.chokyo_reigai, s2.chokyo_awase, s2.chokyo_awase_flag, s2.chokyo_tanpyo,
      s2.chokyo_honsu_course, s2.chokyo_honsu_hanro, s2.chokyo_honsu_pool,
      k.ketto1_f_hanshoku_toroku_bango, k.ketto1_f_bamei, k.ketto2_m_hanshoku_toroku_bango, k.ketto2_m_bamei,
      k.ketto5_mf_hanshoku_toroku_bango, k.ketto5_mf_bamei,
      r.kyori, r.kyori_kubun, r.track_code1_dirtsiba_label, r.toroku_tosu_num,
      s1.tansho1_haraimodoshikin, s1.fukusho1_haraimodoshikin
    FROM
      ${ref("kol_den2")} AS d2
    LEFT JOIN
      ${ref("kol_sei2")} AS s2 ON d2.race_code_uma_kol = s2.race_code_uma_kol
    LEFT JOIN
      ${ref("kol_sei1")} AS s1 ON SUBSTR(d2.race_code_uma_kol, 1, 16) = s1.race_code_kol
    LEFT JOIN
      ${ref("kol_ket")} AS k ON d2.ketto_toroku_bango = k.ketto_toroku_bango_kol
    LEFT JOIN
      ${ref("race")} AS r ON SUBSTR(d2.race_code_uma_kol, 1, 16) = r.race_code_kol
  ),

-- CTE Step2: ウィンドウ関数を使い、馬ごとに1つ前のレース情報を取得
  with_zensou_data AS (
    SELECT
      *,
      LAG(bataiju, 1) OVER (PARTITION BY ketto_toroku_bango ORDER BY hasso_date) AS bataiju_zensou,
      LAG(kyori_kubun, 1) OVER (PARTITION BY ketto_toroku_bango ORDER BY hasso_date) AS kyori_kubun_zensou,
      LAG(kyori, 1) OVER (PARTITION BY ketto_toroku_bango ORDER BY hasso_date) AS kyori_zensou,
      LAG(track_code1_dirtsiba_label, 1) OVER (PARTITION BY ketto_toroku_bango ORDER BY hasso_date) AS track_code1_label_dirtsiba_zensou
    FROM
      base_data
  )

-- Final Step: 全ての情報を結合し、最終的なカラムを生成
SELECT
  -- ID / コード
  z.race_code_uma_kol,
  z.kaisai_nengappi || z.keibajo_code_jvd_from_kol || z.kaisai_kaiji || z.kaisai_nichiji || z.race_num || z.umaban AS race_code_uma_jvd,
  z.race_code_kol,
  z.kaisai_nengappi || z.keibajo_code_jvd_from_kol || z.kaisai_kaiji || z.kaisai_nichiji || z.race_num AS race_code_jvd,
  z.keibajo_code_jvd_from_kol AS keibajo_code_jvd,
  z.keibajo_code AS keibajo_code_kol,
  z.hasso_date,
  z.kaiji,
  z.nichiji,
  z.race_num AS race_bango,
  SAFE_CAST(z.race_num AS INT64) AS race_bango_num,
  CASE WHEN z.toroku_tosu_num <= 8 THEN '中' WHEN z.wakuban = '1' THEN '内枠' WHEN z.wakuban = '8' THEN '外枠' ELSE '中' END AS waku_kubun,
  z.wakuban,
  z.umaban,
  SAFE_CAST(z.umaban AS INT64) AS umaban_num,
  CASE WHEN MOD(SAFE_CAST(z.umaban AS INT64), 2) = 0 THEN 'はい' ELSE 'いいえ' END AS umaban_even,
  z.bamei,
  z.seibetsu_code,
  CASE z.seibetsu_code WHEN '1' THEN '牡' WHEN '2' THEN '牝' WHEN '3' THEN 'せん' ELSE NULL END AS seibetsu_code_label,
  z.barei,
  SAFE_CAST(z.barei AS INT64) AS barei_num,
  z.futan_juryo,
  SAFE_CAST(z.futan_juryo AS FLOAT64) / 10 AS futan_juryo_float,
  z.blinker_shiyo_kubun,
  CASE z.blinker_shiyo_kubun WHEN '1' THEN 'はい' ELSE 'いいえ' END AS blinker_shiyo_kubun_label,
  z.rating,
  SAFE_CAST(z.rating AS FLOAT64) / 10 AS rating_float,
  z.banushimei,
  z.banushimei_ryakusho,
  z.ketto_toroku_bango AS ketto_toroku_bango_kol,
  z.ketto1_f_hanshoku_toroku_bango,
  z.ketto1_f_bamei,
  z.ketto2_m_hanshoku_toroku_bango,
  z.ketto2_m_bamei,
  z.ketto5_mf_hanshoku_toroku_bango,
  z.ketto5_mf_bamei,
  z.kyuyo_riyu,
  z.kishumei,
  z.kishumei_ryakusho,
  z.kishu_code,
  z.kishu_tozai_shozoku_code,
  CASE z.kishu_tozai_shozoku_code WHEN '1' THEN '西' WHEN '2' THEN '東' WHEN '3' THEN '招待' ELSE NULL END AS kishu_tozai_shozoku_code_label,
  z.kishu_minarai_code,
  CASE z.kishu_minarai_code WHEN '1' THEN '1kg減' WHEN '2' THEN '2kg減' WHEN '3' THEN '3kg減' WHEN '4' THEN '4kg減' WHEN '5' THEN '女性2kg減' ELSE NULL END AS kishu_minarai_code_label,
  z.kishu_norikawari_kubun,
  CASE z.kishu_norikawari_kubun WHEN '1' THEN 'はい' ELSE 'いいえ' END AS kishu_norikawari_kubun_label,
  z.kishu_shozokubasho_code,
  CASE z.kishu_shozokubasho_code WHEN '001' THEN '栗東' WHEN '002' THEN '美浦南' WHEN '003' THEN '美浦北' ELSE NULL END AS kishu_shozokubasho_code_label,
  z.kishu_shozoku_chokyoshi_code,
  z.chokyoshi_code,
  z.chokyoshimei,
  z.chokyoshimei_ryakusho,
  z.chokyoshi_shozokubasho_code,
  CASE z.chokyoshi_shozokubasho_code WHEN '001' THEN '栗東' WHEN '002' THEN '美浦南' WHEN '003' THEN '美浦北' ELSE NULL END AS chokyoshi_shozokubasho_code_label,
  z.chokyoshi_tracen_kubun,
  CASE z.chokyoshi_tracen_kubun WHEN '1' THEN '栗東' WHEN '2' THEN '美浦南' WHEN '3' THEN '美浦北' ELSE NULL END AS chokyoshi_tracen_kubun_label,
  z.chokyo_flag,
  CASE z.chokyo_flag WHEN '1' THEN 'はい' ELSE 'いいえ' END AS chokyo_flag_label,
  z.chokyo_kijosha,
  PARSE_DATE('%Y%m%d', z.chokyo_nengappi) AS chokyo_date,
  z.chokyo_basho,
  z.chokyo_course,
  z.chokyo_babajotai,
  z.chokyo_1f,
  z.chokyo_3f,
  z.chokyo_4f,
  z.chokyo_5f,
  z.chokyo_6f,
  z.chokyo_7f,
  z.chokyo_8f,
  z.chokyo_ichidori,
  z.chokyo_ashiiro,
  z.chokyo_yajirushi,
  CASE z.chokyo_yajirushi WHEN '1' THEN '一変(↑)' WHEN '2' THEN '平行(→)' WHEN '3' THEN '下降(↓)' WHEN '4' THEN '良化(／)' WHEN '5' THEN '下降気味(＼)' ELSE NULL END AS chokyo_yajirushi_label,
  z.chokyo_reigai,
  z.chokyo_awase,
  CASE WHEN z.chokyo_awase LIKE '%同入%' THEN '同入' WHEN z.chokyo_awase LIKE '%遅れ%' THEN '遅れ' WHEN z.chokyo_awase LIKE '%先着%' THEN '先着' ELSE NULL END AS chokyo_awase_kubun,
  z.chokyo_awase_flag,
  CASE z.chokyo_awase_flag WHEN '1' THEN '調教2の併せ' WHEN '2' THEN '調教3の併せ' ELSE NULL END AS chokyo_awase_flag_label,
  z.chokyo_tanpyo,
  z.chokyo_honsu_course,
  SAFE_CAST(z.chokyo_honsu_course AS INT64) AS chokyo_honsu_course_num,
  z.chokyo_honsu_hanro,
  SAFE_CAST(z.chokyo_honsu_hanro AS INT64) AS chokyo_honsu_hanro_num,
  z.chokyo_honsu_pool,
  SAFE_CAST(z.chokyo_honsu_pool AS INT64) AS chokyo_honsu_pool_num,
  z.speed_shisu1 AS speed_sisu_last_1,
  SAFE_CAST(z.speed_shisu1 AS FLOAT64) / 10 AS speed_sisu_last_1_float,
  z.speed_shisu2 AS speed_sisu_last_2,
  SAFE_CAST(z.speed_shisu2 AS FLOAT64) / 10 AS speed_sisu_last_2_float,
  z.speed_shisu3 AS speed_sisu_last_3,
  SAFE_CAST(z.speed_shisu3 AS FLOAT64) / 10 AS speed_sisu_last_3_float,
  z.speed_shisu4 AS speed_sisu_last_4,
  SAFE_CAST(z.speed_shisu4 AS FLOAT64) / 10 AS speed_sisu_last_4_float,
  z.speed_shisu5 AS speed_sisu_last_5,
  SAFE_CAST(z.speed_shisu5 AS FLOAT64) / 10 AS speed_sisu_last_5_float,
  z.rotation1,
  SUBSTR(z.rotation1, 1, 1) AS rotation1_label,
  z.rotation2,
  SUBSTR(z.rotation2, 1, 1) AS rotation2_label,
  z.rotation3,
  SUBSTR(z.rotation3, 1, 1) AS rotation3_label,
  z.rotation4,
  SUBSTR(z.rotation4, 1, 1) AS rotation4_label,
  z.rotation5,
  SUBSTR(z.rotation5, 1, 1) AS rotation5_label,
  z.rotation6,
  SUBSTR(z.rotation6, 1, 1) AS rotation6_label,
  z.rotation7,
  SUBSTR(z.rotation7, 1, 1) AS rotation7_label,
  z.rotation8,
  SUBSTR(z.rotation8, 1, 1) AS rotation8_label,
  z.bataiju,
  CASE 
    WHEN SAFE_CAST(z.bataiju AS INT64) >= 500 THEN '500kg以上'
    WHEN SAFE_CAST(z.bataiju AS INT64) BETWEEN 480 AND 499 THEN '480～499kg'
    WHEN SAFE_CAST(z.bataiju AS INT64) BETWEEN 460 AND 479 THEN '460～479kg'
    WHEN SAFE_CAST(z.bataiju AS INT64) BETWEEN 440 AND 459 THEN '440～459kg'
    WHEN SAFE_CAST(z.bataiju AS INT64) < 440 THEN '439kg以下'
    ELSE NULL
  END AS bataiju_kubun,
  z.bataiju_zensou,
  CASE 
    WHEN SAFE_CAST(z.bataiju_zensou AS INT64) >= 500 THEN '500kg以上'
    WHEN SAFE_CAST(z.bataiju_zensou AS INT64) BETWEEN 480 AND 499 THEN '480～499kg'
    WHEN SAFE_CAST(z.bataiju_zensou AS INT64) BETWEEN 460 AND 479 THEN '460～479kg'
    WHEN SAFE_CAST(z.bataiju_zensou AS INT64) BETWEEN 440 AND 459 THEN '440～459kg'
    WHEN SAFE_CAST(z.bataiju_zensou AS INT64) < 440 THEN '439kg以下'
    ELSE NULL
  END AS bataiju_kubun_zensou,
  z.kyori_kubun_zensou,
  CASE WHEN z.kyori > z.kyori_zensou THEN 'はい' ELSE 'いいえ' END AS kyori_extension_flag,
  CASE WHEN z.kyori < z.kyori_zensou THEN 'はい' ELSE 'いいえ' END AS kyori_shortening_flag,
  CASE WHEN (z.chokyoshi_tracen_kubun = '1' AND z.keibajo_code IN ('04', '05', '07', '06')) THEN 'はい' ELSE 'いいえ' END AS ensei_kansai_to_kantou_flag,
  CASE WHEN z.chokyoshi_tracen_kubun IN ('2', '3') AND z.keibajo_code IN ('00', '01', '03', '02') THEN 'はい' ELSE 'いいえ' END AS ensei_kantou_to_kansai_flag,
  CASE WHEN (z.chokyoshi_tracen_kubun = '1' AND z.keibajo_code IN ('04', '05', '07', '06')) OR (z.chokyoshi_tracen_kubun IN ('2', '3') AND z.keibajo_code IN ('00', '01', '03', '02')) THEN 'はい' ELSE 'いいえ' END AS ensei_flag,
  z.track_code1_label_dirtsiba_zensou,
  CASE WHEN z.track_code1_label_dirtsiba_zensou = '芝' AND z.track_code1_dirtsiba_label = 'ダ' THEN 'はい' ELSE 'いいえ' END AS siba_to_dirt_flag,
  CASE WHEN z.track_code1_label_dirtsiba_zensou = 'ダ' AND z.track_code1_dirtsiba_label = '芝' THEN 'はい' ELSE 'いいえ' END AS dirt_to_siba_flag,
  z.record_shisu,
  SAFE_CAST(z.record_shisu AS INT64) AS record_shisu_num,
  z.zogen_sa,
  SAFE_CAST(z.zogen_sa AS INT64) AS zogen_sa_num,
  z.tansho_ninkijun,
  SAFE_CAST(z.tansho_ninkijun AS INT64) AS tansho_ninkijun_num,
  z.tansho_odds,
  SAFE_CAST(z.tansho_odds AS FLOAT64) / 10 AS tansho_odds_float,
  z.kakutei_chakujun,
  SAFE_CAST(z.kakutei_chakujun AS INT64) AS kakutei_chakujun_num,
  z.tansho1_haraimodoshikin AS tansho_haraimodoshi,
  z.fukusho1_haraimodoshikin AS fukusho_haraimodoshi,
  z.ijo_kubun_code1,
  CASE z.ijo_kubun_code1 WHEN '1' THEN '落馬' WHEN '2' THEN '失格' WHEN '3' THEN '中止' WHEN '4' THEN '取消' WHEN '5' THEN '除外' WHEN '6' THEN '降着' WHEN '7' THEN '繰上げ' ELSE NULL END AS ijo_kubun_code1_label,
  z.ijo_kubun_code2,
  CASE z.ijo_kubun_code2 WHEN '01' THEN '出走取消' WHEN '02' THEN '出走除外' WHEN '03' THEN '競走除外' WHEN '04' THEN '競走中止' WHEN '05' THEN '放馬' WHEN '06' THEN '発走除外' ELSE NULL END AS ijo_kubun_code2_label,
  z.nyusen_juni,
  SAFE_CAST(z.nyusen_juni AS INT64) AS nyusen_juni_num,
  z.record_flag,
  CASE z.record_flag WHEN '1' THEN 'はい' ELSE 'いいえ' END AS record_flag_label,
  z.soha_time,
  SAFE_CAST(SUBSTR(z.soha_time, 1, 1) AS FLOAT64) * 60 + SAFE_CAST(SUBSTR(z.soha_time, 2, 2) AS FLOAT64) + SAFE_CAST(SUBSTR(z.soha_time, 4, 1) AS FLOAT64) / 10 AS soha_time_float,
  SUBSTR(z.soha_time, 1, 1) || '分' || SUBSTR(z.soha_time, 2, 2) || '.' || SUBSTR(z.soha_time, 4, 1) || '秒' AS soha_time_label,
  z.chakusa_code1,
  SAFE_CAST(z.chakusa_code1 AS INT64) AS chakusa_code1_num,
  z.chakusa_code2,
  CASE z.chakusa_code2 
    WHEN 'A' THEN 'ハナ' WHEN 'B' THEN 'アタマ' WHEN 'C' THEN 'クビ' 
    WHEN 'D' THEN '1/2' WHEN 'E' THEN '3/4' WHEN 'F' THEN '1' 
    WHEN 'G' THEN '1.1/4' WHEN 'H' THEN '1.1/2' WHEN 'I' THEN '1.3/4' 
    WHEN 'J' THEN '2' WHEN 'K' THEN '2.1/2' WHEN 'L' THEN '3' 
    WHEN 'M' THEN '3.1/2' WHEN 'N' THEN '4' WHEN 'O' THEN '5' 
    WHEN 'P' THEN '6' WHEN 'Q' THEN '7' WHEN 'R' THEN '8' 
    WHEN 'S' THEN '9' WHEN 'T' THEN '10' WHEN 'U' THEN '大差' 
    ELSE NULL 
  END AS chakusa_code2_label,
  CASE WHEN z.chakusa_code1 IS NOT NULL AND z.chakusa_code1 != ' ' THEN z.chakusa_code1 || '馬身' ELSE '' END ||
  CASE z.chakusa_code2 
    WHEN 'A' THEN 'ハナ' WHEN 'B' THEN 'アタマ' WHEN 'C' THEN 'クビ' 
    WHEN 'D' THEN '1/2' WHEN 'E' THEN '3/4' WHEN 'F' THEN '1' 
    WHEN 'G' THEN '1.1/4' WHEN 'H' THEN '1.1/2' WHEN 'I' THEN '1.3/4' 
    WHEN 'J' THEN '2' WHEN 'K' THEN '2.1/2' WHEN 'L' THEN '3' 
    WHEN 'M' THEN '3.1/2' WHEN 'N' THEN '4' WHEN 'O' THEN '5' 
    WHEN 'P' THEN '6' WHEN 'Q' THEN '7' WHEN 'R' THEN '8' 
    WHEN 'S' THEN '9' WHEN 'T' THEN '10' WHEN 'U' THEN '大差' 
    ELSE '' 
  END AS chakusa_label,
  z.time_sa,
  SAFE_CAST(z.time_sa AS FLOAT64) / 10 AS time_sa_float,
  z.zenhan_3f,
  SAFE_CAST(z.zenhan_3f AS FLOAT64) / 10 AS zenhan_3f_float,
  z.kohan_3f,
  SAFE_CAST(z.kohan_3f AS FLOAT64) / 10 AS kohan_3f_float,
  z.corner1_juni,
  CASE WHEN SAFE_CAST(z.corner1_juni AS INT64) IS NULL THEN z.corner1_juni ELSE LPAD(z.corner1_juni, 2, '0') END AS corner1_juni_label,
  z.corner2_juni,
  CASE WHEN SAFE_CAST(z.corner2_juni AS INT64) IS NULL THEN z.corner2_juni ELSE LPAD(z.corner2_juni, 2, '0') END AS corner2_juni_label,
  z.corner3_juni,
  CASE WHEN SAFE_CAST(z.corner3_juni AS INT64) IS NULL THEN z.corner3_juni ELSE LPAD(z.corner3_juni, 2, '0') END AS corner3_juni_label,
  z.corner4_juni,
  CASE WHEN SAFE_CAST(z.corner4_juni AS INT64) IS NULL THEN z.corner4_juni ELSE LPAD(z.corner4_juni, 2, '0') END AS corner4_juni_label,
  z.corner4_ichidori,
  CASE z.corner4_ichidori WHEN '1' THEN '最内' WHEN '2' THEN '内' WHEN '3' THEN '中' WHEN '4' THEN '外' WHEN '5' THEN '大外' ELSE NULL END AS corner4_ichidori_label,
  CURRENT_TIMESTAMP() AS created,
  CURRENT_TIMESTAMP() AS modified
FROM
  with_zensou_data AS z